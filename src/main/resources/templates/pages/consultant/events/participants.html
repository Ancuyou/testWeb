<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/head :: head('Danh sách Người đăng ký - QAUTE')}"></th:block>
<body>
<th:block th:replace="~{fragments/consultant/consultant-navbar :: consultant-navbar}"></th:block>

<div class="container-fluid" style="margin-top: 80px;">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <!-- Page Header -->
            <div class="mb-4">
                <div class="d-flex align-items-center">
                    <a th:href="@{/consultant/events/details/{id}(id=${event.eventID})}" class="btn btn-outline-secondary me-3">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="flex-grow-1">
                        <h2 class="fw-bold mb-1">
                            <i class="fas fa-users text-primary me-2"></i>Danh sách người đăng ký
                        </h2>
                        <p class="text-muted mb-0">
                            Sự kiện: <span class="fw-semibold" th:text="${event.title}">Tiêu đề sự kiện</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">Tổng đăng ký</h6>
                                    <h2 class="mb-0 fw-bold" th:text="${participants.size()}">0</h2>
                                </div>
                                <i class="fas fa-users fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">Đã xác nhận</h6>
                                    <span th:text="${confirmedCount}"></span>
                                </div>
                                <i class="fas fa-check-circle fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">Đã tham dự</h6>
                                    <span th:text="${attendedCount}"></span>
                                </div>
                                <i class="fas fa-user-check fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-1">Vắng mặt</h6>
                                    <span class="mb-0 fw-bold" th:text="${absentCount}">0</span>
                                </div>
                                <i class="fas fa-user-times fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants List -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        Danh sách chi tiết (<span th:text="${participants.size()}">0</span> người)
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>Xuất Excel
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>In
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div th:if="${participants != null && !participants.isEmpty()}">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="participantsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 25%;">Người tham gia</th>
                                        <th style="width: 15%;">MSSV/Email</th>
                                        <th style="width: 15%;">Khoa</th>
                                        <th style="width: 15%;">Thời gian đăng ký</th>
                                        <th style="width: 10%;">Trạng thái</th>
                                        <th style="width: 15%;" class="text-end">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="reg, iterStat : ${participants}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img th:src="${reg.user.profile.avatar != null ? reg.user.profile.avatar : '/images/default-avatar.jpg'}" 
                                                     class="rounded-circle me-3" 
                                                     style="width: 40px; height: 40px; object-fit: cover;"
                                                     alt="Avatar">
                                                <div>
                                                    <div class="fw-semibold" th:text="${reg.user.profile.fullName}">Nguyễn Văn A</div>
                                                    <small class="text-muted" th:if="${reg.user.profile.phone != null}" 
                                                           th:text="${reg.user.profile.phone}">0123456789</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div th:if="${reg.user.student != null}">
                                                <span class="fw-semibold" th:text="${reg.user.student.studentCode}">21110XXX</span>
                                            </div>
                                            <small class="text-muted d-block" th:text="${reg.user.account.email}">email@example.com</small>
                                        </td>
                                        <td>
                                            <span th:if="${reg.user.student != null && reg.user.student.department != null}" 
                                                  th:text="${reg.user.student.department.departmentName}">Khoa CNTT</span>
                                            <span th:if="${reg.user.student == null}" class="text-muted">--</span>
                                        </td>
                                        <td>
                                            <small th:text="${#temporals.format(reg.registeredAt, 'dd/MM/yyyy HH:mm')}">
                                                01/01/2025 10:00
                                            </small>
                                        </td>
                                        <td>
                                            <span th:if="${reg.status.toString() == 'Registered'}" class="badge bg-info">
                                                <i class="fas fa-clock me-1"></i>Đã đăng ký
                                            </span>
                                            <span th:if="${reg.status.toString() == 'Confirmed'}" class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Đã xác nhận
                                            </span>
                                            <span th:if="${reg.status.toString() == 'Attended'}" class="badge bg-primary">
                                                <i class="fas fa-user-check me-1"></i>Đã tham dự
                                            </span>
                                            <span th:if="${reg.status.toString() == 'Absent'}" class="badge bg-warning">
                                                <i class="fas fa-user-times me-1"></i>Vắng mặt
                                            </span>
                                            <span th:if="${reg.status.toString() == 'Cancelled'}" class="badge bg-danger">
                                                <i class="fas fa-ban me-1"></i>Đã hủy
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        th:data-bs-target="'#detailModal' + ${reg.registrationID}"
                                                        title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>

                                            <!-- Detail Modal -->
                                            <div class="modal fade" th:id="'detailModal' + ${reg.registrationID}" tabindex="-1">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">
                                                                <i class="fas fa-user-circle text-primary me-2"></i>
                                                                Thông tin chi tiết
                                                            </h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="row">
                                                                <div class="col-md-4 text-center mb-3">
                                                                    <img th:src="${reg.user.profile.avatar != null ? reg.user.profile.avatar : '/images/default-avatar.jpg'}" 
                                                                         class="rounded-circle border" 
                                                                         style="width: 120px; height: 120px; object-fit: cover;"
                                                                         alt="Avatar">
                                                                    <h5 class="mt-3 fw-bold" th:text="${reg.user.profile.fullName}">Nguyễn Văn A</h5>
                                                                    <span th:if="${reg.status.toString() == 'Registered'}" class="badge bg-info">Đã đăng ký</span>
                                                                    <span th:if="${reg.status.toString() == 'Confirmed'}" class="badge bg-success">Đã xác nhận</span>
                                                                    <span th:if="${reg.status.toString() == 'Attended'}" class="badge bg-primary">Đã tham dự</span>
                                                                    <span th:if="${reg.status.toString() == 'Absent'}" class="badge bg-warning">Vắng mặt</span>
                                                                    <span th:if="${reg.status.toString() == 'Cancelled'}" class="badge bg-danger">Đã hủy</span>
                                                                </div>
                                                                <div class="col-md-8">
                                                                    <h6 class="fw-bold mb-3 text-primary">
                                                                        <i class="fas fa-info-circle me-2"></i>Thông tin cá nhân
                                                                    </h6>
                                                                    <table class="table table-sm">
                                                                        <tr th:if="${reg.user.student != null}">
                                                                            <td class="text-muted" style="width: 40%;">MSSV:</td>
                                                                            <td class="fw-semibold" th:text="${reg.user.student.studentCode}">21110XXX</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="text-muted">Email:</td>
                                                                            <td th:text="${reg.user.account.email}">email@example.com</td>
                                                                        </tr>
                                                                        <tr th:if="${reg.user.profile.phone != null}">
                                                                            <td class="text-muted">Số điện thoại:</td>
                                                                            <td th:text="${reg.user.profile.phone}">0123456789</td>
                                                                        </tr>
                                                                        <tr th:if="${reg.user.student != null && reg.user.student.department != null}">
                                                                            <td class="text-muted">Khoa:</td>
                                                                            <td th:text="${reg.user.student.department.departmentName}">Khoa CNTT</td>
                                                                        </tr>
                                                                        <tr th:if="${reg.user.profile.dateOfBirth != null}">
                                                                            <td class="text-muted">Ngày sinh:</td>
                                                                            <td th:text="${#temporals.format(reg.user.profile.dateOfBirth, 'dd/MM/yyyy')}">01/01/2000</td>
                                                                        </tr>
                                                                    </table>

                                                                    <h6 class="fw-bold mb-3 mt-4 text-primary">
                                                                        <i class="fas fa-calendar me-2"></i>Thông tin đăng ký
                                                                    </h6>
                                                                    <table class="table table-sm">
                                                                        <tr>
                                                                            <td class="text-muted" style="width: 40%;">Thời gian đăng ký:</td>
                                                                            <td th:text="${#temporals.format(reg.registeredAt, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:00</td>
                                                                        </tr>
                                                                        <tr th:if="${reg.attendedAt != null}">
                                                                            <td class="text-muted">Thời gian tham dự:</td>
                                                                            <td th:text="${#temporals.format(reg.attendedAt, 'dd/MM/yyyy HH:mm')}">01/01/2025 14:00</td>
                                                                        </tr>
                                                                        <tr th:if="${reg.note != null}">
                                                                            <td class="text-muted">Ghi chú:</td>
                                                                            <td th:text="${reg.note}">Ghi chú từ người đăng ký</td>
                                                                        </tr>
                                                                    </table>

                                                                    <div th:if="${reg.feedback != null}" class="mt-4">
                                                                        <h6 class="fw-bold mb-3 text-primary">
                                                                            <i class="fas fa-comment me-2"></i>Đánh giá
                                                                        </h6>
                                                                        <div th:if="${reg.rating != null}" class="mb-2">
                                                                            <span th:each="i : ${#numbers.sequence(1, 5)}">
                                                                                <i th:class="${i <= reg.rating ? 'fas fa-star text-warning' : 'far fa-star text-muted'}"></i>
                                                                            </span>
                                                                            <span class="ms-2" th:text="${reg.rating + '/5'}">5/5</span>
                                                                        </div>
                                                                        <p class="text-muted mb-0" th:text="${reg.feedback}">Feedback content</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div th:if="${participants == null || participants.isEmpty()}" class="text-center py-5">
                        <i class="fas fa-users-slash fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Chưa có người đăng ký</h5>
                        <p class="text-muted">Người dùng sẽ xuất hiện ở đây khi họ đăng ký sự kiện</p>
                    </div>
                </div>
            </div>

            <!-- Event Info Card -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>Thông tin sự kiện
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Thời gian:</small>
                                    <span class="fw-semibold" th:text="${#temporals.format(event.startTime, 'dd/MM/yyyy HH:mm')}">
                                        01/01/2025 09:00
                                    </span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Hình thức:</small>
                                    <span th:text="${event.mode}">Online</span>
                                </div>
                                <div class="col-12" th:if="${event.location != null}">
                                    <small class="text-muted d-block">Địa điểm:</small>
                                    <span th:text="${event.location}">Phòng A.101</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-download text-primary me-2"></i>Xuất dữ liệu
                            </h6>
                            <p class="text-muted small mb-3">
                                Tải xuống danh sách người đăng ký để sử dụng offline hoặc báo cáo
                            </p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel me-2"></i>Xuất Excel
                                </button>
                                <button class="btn btn-outline-danger" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>Xuất PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Export to Excel
function exportToExcel() {
    const table = document.getElementById('participantsTable');
    let html = '<table>';
    
    // Headers
    html += '<thead><tr>';
    html += '<th>STT</th>';
    html += '<th>Họ và tên</th>';
    html += '<th>MSSV</th>';
    html += '<th>Email</th>';
    html += '<th>Số điện thoại</th>';
    html += '<th>Khoa</th>';
    html += '<th>Thời gian đăng ký</th>';
    html += '<th>Trạng thái</th>';
    html += '</tr></thead>';
    
    // Body
    html += '<tbody>';
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        html += '<tr>';
        html += `<td>${index + 1}</td>`;
        html += `<td>${cells[1].textContent.trim()}</td>`;
        html += `<td>${cells[2].querySelector('.fw-semibold')?.textContent.trim() || ''}</td>`;
        html += `<td>${cells[2].querySelector('.text-muted')?.textContent.trim() || ''}</td>`;
        html += `<td>${cells[1].querySelector('.text-muted')?.textContent.trim() || ''}</td>`;
        html += `<td>${cells[3].textContent.trim()}</td>`;
        html += `<td>${cells[4].textContent.trim()}</td>`;
        html += `<td>${cells[5].textContent.trim()}</td>`;
        html += '</tr>';
    });
    html += '</tbody></table>';
    
    const uri = 'data:application/vnd.ms-excel;base64,';
    const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Participants</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="UTF-8"></head><body>' + html + '</body></html>';
    
    const base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) };
    const link = document.createElement('a');
    link.href = uri + base64(template);
    link.download = 'danh-sach-dang-ky-' + new Date().getTime() + '.xls';
    link.click();
}

// Export to PDF
function exportToPDF() {
    window.print();
}

// Print styles
const style = document.createElement('style');
style.textContent = `
    @media print {
        body * {
            visibility: hidden;
        }
        #participantsTable, #participantsTable * {
            visibility: visible;
        }
        #participantsTable {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .btn-group {
            display: none !important;
        }
    }
`;
document.head.appendChild(style);
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/toast :: toast}"></div>
</body>
</html>