<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/head :: head('Chi tiết Sự kiện - QAUTE')}"></th:block>
<body>
<th:block th:replace="~{fragments/consultant/consultant-navbar :: consultant-navbar}"></th:block>

<div class="container-fluid" style="margin-top: 80px;">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <a th:href="@{/consultant/events}" class="btn btn-outline-secondary me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h2 class="fw-bold mb-1" th:text="${event.title}">Tiêu đề sự kiện</h2>
                            <div>
                                <span th:if="${event.status.toString() == 'Pending'}" class="badge bg-warning me-2">
                                    <i class="fas fa-clock me-1"></i>Chờ duyệt
                                </span>
                                <span th:if="${event.status.toString() == 'Approved'}" class="badge bg-success me-2">
                                    <i class="fas fa-check-circle me-1"></i>Đã duyệt
                                </span>
                                <span th:if="${event.status.toString() == 'Rejected'}" class="badge bg-danger me-2">
                                    <i class="fas fa-times-circle me-1"></i>Từ chối
                                </span>
                                <span th:if="${event.status.toString() == 'Ongoing'}" class="badge bg-primary me-2">
                                    <i class="fas fa-play-circle me-1"></i>Đang diễn ra
                                </span>
                                <span th:if="${event.status.toString() == 'Completed'}" class="badge bg-secondary me-2">
                                    <i class="fas fa-check-double me-1"></i>Hoàn thành
                                </span>
                                <span th:if="${event.status.toString() == 'Cancelled'}" class="badge bg-dark me-2">
                                    <i class="fas fa-ban me-1"></i>Đã hủy
                                </span>
                                <span class="badge bg-info" th:text="${event.type}">Type</span>
                            </div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <a th:if="${canEdit}" 
                            th:href="@{/consultant/events/edit/{id}(id=${event.eventID})}"
                           class="btn btn-warning">
                            <i class="fas fa-edit me-1"></i>Chỉnh sửa
                        </a>
                        <button th:if="${canCancel}" 
                                type="button" 
                                class="btn btn-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#cancelModal">
                            <i class="fas fa-ban me-1"></i>Hủy sự kiện
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Banner & Description -->
                    <div class="card border-0 shadow-sm mb-4">
                        <img th:if="${event.banner != null}" 
                             th:src="${event.banner}" 
                             class="card-img-top" 
                             style="height: 300px; object-fit: cover;"
                             alt="Event Banner">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-align-left text-primary me-2"></i>Mô tả sự kiện
                            </h5>
                            <p class="text-muted" style="white-space: pre-line;" th:text="${event.description}">
                                Mô tả chi tiết về sự kiện
                            </p>
                        </div>
                    </div>

                    <!-- Event Info -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-info-circle text-primary me-2"></i>Thông tin chi tiết
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-calendar-alt text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Thời gian bắt đầu</small>
                                            <span class="fw-semibold" th:text="${#temporals.format(event.startTime, 'dd/MM/yyyy HH:mm')}">
                                                01/01/2025 09:00
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-calendar-check text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Thời gian kết thúc</small>
                                            <span class="fw-semibold" th:text="${#temporals.format(event.endTime, 'dd/MM/yyyy HH:mm')}">
                                                01/01/2025 11:00
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-layer-group text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Hình thức</small>
                                            <span th:if="${event.mode.toString() == 'Online'}" class="badge bg-primary">
                                                <i class="fas fa-video me-1"></i>Online
                                            </span>
                                            <span th:if="${event.mode.toString() == 'Offline'}" class="badge bg-success">
                                                <i class="fas fa-map-marker-alt me-1"></i>Offline
                                            </span>
                                            <span th:if="${event.mode.toString() == 'Hybrid'}" class="badge bg-warning">
                                                <i class="fas fa-layer-group me-1"></i>Hybrid
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-users text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Người tham gia</small>
                                            <span class="fw-semibold">
                                                <span th:text="${event.currentParticipants}">0</span>
                                                <span th:if="${event.maxParticipants != null}">
                                                    / <span th:text="${event.maxParticipants}">50</span>
                                                </span>
                                                <span th:if="${event.maxParticipants == null}">
                                                    / Không giới hạn
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12" th:if="${event.location != null && event.mode.toString() != 'Online'}">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-map-marker-alt text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Địa điểm</small>
                                            <span class="fw-semibold" th:text="${event.location}">Phòng A.101</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12" th:if="${event.meetingLink != null && event.mode.toString() != 'Offline'}">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-video text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Link họp online</small>
                                            <a th:href="${event.meetingLink}" target="_blank" class="text-decoration-none">
                                                <i class="fas fa-external-link-alt me-1"></i>Tham gia ngay
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" th:if="${event.department != null}">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-building text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Khoa/Phòng ban</small>
                                            <span class="fw-semibold" th:text="${event.department.departmentName}">Khoa CNTT</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" th:if="${event.field != null}">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-tag text-primary me-3 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">Lĩnh vực</small>
                                            <span class="fw-semibold" th:text="${event.field.fieldName}">Học thuật</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rejection Reason -->
                    <div th:if="${event.status.toString() == 'Rejected' && event.rejectionReason != null}" 
                         class="card border-0 shadow-sm border-danger mb-4">
                        <div class="card-body">
                            <h5 class="fw-bold text-danger mb-3">
                                <i class="fas fa-times-circle me-2"></i>Lý do từ chối
                            </h5>
                            <p class="mb-0" th:text="${event.rejectionReason}">Nội dung không phù hợp</p>
                        </div>
                    </div>

                    <!-- Participants List -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-semibold">
                                <i class="fas fa-users text-primary me-2"></i>
                                Danh sách người đăng ký (<span th:text="${participants.size()}">0</span>)
                            </h5>
                            <a th:href="@{/consultant/events/participants/{id}(id=${event.eventID})}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>Xem chi tiết
                            </a>
                        </div>
                        <div class="card-body">
                            <div th:if="${participants != null && !participants.isEmpty()}">
                                <div class="list-group list-group-flush">
                                    <div th:each="reg, iterStat : ${participants}" 
                                         th:if="${iterStat.index < 5}"
                                         class="list-group-item px-0">
                                        <div class="d-flex align-items-center">
                                            <img th:src="${reg.user.profile.avatar != null ? reg.user.profile.avatar : '/images/default-avatar.jpg'}" 
                                                 class="rounded-circle me-3" 
                                                 style="width: 40px; height: 40px; object-fit: cover;"
                                                 alt="Avatar">
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold" th:text="${reg.user.profile.fullName}">Nguyễn Văn A</div>
                                                <small class="text-muted">
                                                    Đăng ký: <span th:text="${#temporals.format(reg.registeredAt, 'dd/MM/yyyy HH:mm')}">01/01/2025</span>
                                                </small>
                                            </div>
                                            <span th:if="${reg.status.toString() == 'Registered'}" class="badge bg-info">Đã đăng ký</span>
                                            <span th:if="${reg.status.toString() == 'Confirmed'}" class="badge bg-success">Đã xác nhận</span>
                                            <span th:if="${reg.status.toString() == 'Attended'}" class="badge bg-primary">Đã tham dự</span>
                                            <span th:if="${reg.status.toString() == 'Absent'}" class="badge bg-warning">Vắng mặt</span>
                                            <span th:if="${reg.status.toString() == 'Cancelled'}" class="badge bg-danger">Đã hủy</span>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${participants.size() > 5}" class="text-center mt-3">
                                    <a th:href="@{/consultant/events/participants/{id}(id=${event.eventID})}"
                                       class="btn btn-sm btn-outline-primary">
                                        Xem tất cả <span th:text="${participants.size()}">10</span> người đăng ký
                                    </a>
                                </div>
                            </div>
                            <div th:if="${participants == null || participants.isEmpty()}" class="text-center py-4">
                                <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-0">Chưa có người đăng ký</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Quick Stats -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 fw-semibold">
                                <i class="fas fa-chart-line text-primary me-2"></i>Thống kê
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3 pb-3 border-bottom">
                                <small class="text-muted d-block mb-1">Lượt xem</small>
                                <h4 class="mb-0 fw-bold text-primary">
                                    <i class="fas fa-eye me-2"></i>--
                                </h4>
                            </div>
                            <div class="mb-3 pb-3 border-bottom">
                                <small class="text-muted d-block mb-1">Đã đăng ký</small>
                                <h4 class="mb-0 fw-bold text-success">
                                    <i class="fas fa-user-check me-2"></i>
                                    <span th:text="${event.currentParticipants}">0</span>
                                </h4>
                            </div>
                            <div>
                                <small class="text-muted d-block mb-1">Tỷ lệ lấp đầy</small>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar" role="progressbar" 
                                         th:style="${'width: ' + (event.maxParticipants != null ? (event.currentParticipants * 100.0 / event.maxParticipants) : 0) + '%'}"
                                         th:text="${event.maxParticipants != null ? (#numbers.formatDecimal(event.currentParticipants * 100.0 / event.maxParticipants, 0, 0) + '%') : 'N/A'}">
                                        0%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 fw-semibold">
                                <i class="fas fa-history text-primary me-2"></i>Lịch sử
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="timeline-content">
                                        <small class="text-muted d-block">
                                            <i class="far fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(event.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2025</span>
                                        </small>
                                        <p class="mb-0">Tạo sự kiện</p>
                                    </div>
                                </div>
                                <div th:if="${event.approvedAt != null}" class="timeline-item">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <small class="text-muted d-block">
                                            <i class="far fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(event.approvedAt, 'dd/MM/yyyy HH:mm')}">01/01/2025</span>
                                        </small>
                                        <p class="mb-0">Đã được phê duyệt</p>
                                    </div>
                                </div>
                                <div th:if="${event.updatedAt != null}" class="timeline-item">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <small class="text-muted d-block">
                                            <i class="far fa-clock me-1"></i>
                                            <span th:text="${#temporals.format(event.updatedAt, 'dd/MM/yyyy HH:mm')}">01/01/2025</span>
                                        </small>
                                        <p class="mb-0">Cập nhật lần cuối</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Event Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-ban text-danger me-2"></i>Hủy sự kiện
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/consultant/events/cancel/{id}(id=${event.eventID})}" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Hành động này không thể hoàn tác. Tất cả người đăng ký sẽ được thông báo.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Lý do hủy <span class="text-danger">*</span></label>
                        <textarea name="reason" class="form-control" rows="3" required
                                  placeholder="Vui lòng cho biết lý do hủy sự kiện..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Xác nhận hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}
.timeline-item {
    position: relative;
    padding-bottom: 20px;
}
.timeline-item:last-child {
    padding-bottom: 0;
}
.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -21px;
    top: 15px;
    width: 2px;
    height: calc(100% - 5px);
    background: #dee2e6;
}
.timeline-marker {
    position: absolute;
    left: -26px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}
.timeline-content {
    padding-left: 10px;
}
</style>

<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/toast :: toast}"></div>
</body>
</html>