<th:block th:replace="~{pages/manager/layout-manager :: layout(~{::notifications_content}, 'notifications')}">

    <th:block th:fragment="notifications_content">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-bell me-2"></i>Quản lý thông báo hệ thống
            </h1>
            <a class="btn btn-primary" th:href="@{/manager/notifications/new}">
                <i class="fas fa-plus me-2"></i>Thêm thông báo
            </a>
        </div>

        <!-- Hiển thị thông báo kết quả -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-2" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Form tìm kiếm và lọc -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form th:action="@{/manager/notifications}" method="get" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Tìm kiếm</label>
                        <input type="text" name="q" class="form-control" th:value="${q}"
                               placeholder="Tìm theo tiêu đề, nội dung, người gửi..."/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Trạng thái</label>
                        <select name="status" class="form-select">
                            <option value="">Tất cả</option>
                            <option value="Xuất bản" th:selected="${status == 'Xuất bản'}">Xuất bản</option>
                            <option value="Nháp" th:selected="${status == 'Nháp'}">Nháp</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Tìm kiếm
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bảng danh sách thông báo -->
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th style="width: 150px;">Người gửi</th>
                            <th style="width: 120px;">Đối tượng</th>
                            <th>Tiêu đề</th>
                            <th style="width: 150px;">Ngày tạo</th>
                            <th style="width: 100px;">Trạng thái</th>
                            <th style="width: 120px;" class="text-center">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="n : ${notifications}">
                            <td class="fw-semibold" th:text="${n.notificationID}">1</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle text-primary me-2 fs-5"></i>
                                    <span th:text="${n.sender != null ? n.sender.username : 'N/A'}">Manager</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge"
                                      th:classappend="${n.targetType == 'USER'} ? 'bg-info' : (${n.targetType == 'CONSULTANT'} ? 'bg-warning' : 'bg-secondary')"
                                      th:text="${n.targetType}">USER</span>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 300px;" th:title="${n.title}">
                                    <strong th:text="${n.title}">Thông báo cập nhật hệ thống</strong>
                                </div>
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="far fa-calendar-alt me-1"></i>
                                    <span th:text="${n.createdDate != null ? #dates.format(n.createdDate, 'dd/MM/yyyy HH:mm') : 'N/A'}">14/10/2025 10:30</span>
                                </small>
                            </td>
                            <td>
                                <span th:text="${n.status}"
                                      th:classappend="${n.status == 'Xuất bản'} ? 'badge bg-success' : (${n.status == 'Nháp'} ? 'badge bg-secondary' : 'badge bg-warning')">
                                    Nháp
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-info"
                                       th:href="@{/manager/notifications/view/{id}(id=${n.notificationID})}"
                                       title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a class="btn btn-outline-warning"
                                       th:href="@{/manager/notifications/edit/{id}(id=${n.notificationID})}"
                                       title="Sửa thông báo">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-danger"
                                            title="Xóa thông báo"
                                            th:onclick="'deleteNotification(' + ${n.notificationID} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr th:if="${#lists.isEmpty(notifications)}">
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3 d-block text-muted opacity-50"></i>
                                <p class="mb-0">Không có thông báo nào.</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Phân trang -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination justify-content-center mb-3">
                        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/manager/notifications(page=${currentPage - 1}, size=${size}, q=${q}, status=${status})}">
                                <i class="fas fa-chevron-left"></i> Trước
                            </a>
                        </li>
                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(1, totalPages)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:text="${i}"
                               th:href="@{/manager/notifications(page=${i}, size=${size}, q=${q}, status=${status})}">
                                1
                            </a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/manager/notifications(page=${currentPage + 1}, size=${size}, q=${q}, status=${status})}">
                                Sau <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <p class="text-muted mb-0">
                            Hiển thị <strong th:text="${#lists.size(notifications)}">10</strong> /
                            <strong th:text="${totalItems}">50</strong> thông báo
                        </p>
                        <div class="d-flex align-items-center">
                            <label class="me-2 mb-0 fw-semibold">Số dòng:</label>
                            <form th:action="@{/manager/notifications}" method="get" class="d-inline">
                                <input type="hidden" name="page" value="1"/>
                                <input type="hidden" name="q" th:value="${q}"/>
                                <input type="hidden" name="status" th:value="${status}"/>
                                <select name="size" class="form-select form-select-sm" style="width:80px;" onchange="this.form.submit()">
                                    <option th:each="opt : ${pageSizeOptions}"
                                            th:value="${opt}"
                                            th:text="${opt}"
                                            th:selected="${opt == size}">5</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </th:block>

    <script>
        // Auto dismiss alerts
        document.addEventListener('DOMContentLoaded', () => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.remove('show');
                    alert.classList.add('fade');
                    setTimeout(() => {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                        bsAlert.close();
                    }, 500);
                }, 3000);
            });
        });

        // Delete notification function
        function deleteNotification(id) {
            if (confirm('Bạn có chắc chắn muốn xóa thông báo này?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/manager/notifications/delete/' + id;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</th:block>