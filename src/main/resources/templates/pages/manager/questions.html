<th:block th:replace="~{pages/manager/layout-manager :: layout(~{::questions_content}, 'questions')}">
    <th:block th:fragment="questions_content">

        <div class="container-fluid py-3">
            <!-- Tiêu đề trang -->
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <h2 class="h4 mb-0"><i class="fas fa-question-circle me-2 text-primary"></i>Danh sách câu hỏi</h2>
            </div>

            <!-- Bộ lọc tìm kiếm -->
            <form th:action="@{/manager/questions}" method="get" class="row gy-2 gx-3 align-items-center mb-4">
                <!-- Department -->
                <div class="col-md-3">
                    <label for="departmentSelect" class="form-label fw-semibold">Khoa/Ngành</label>
                    <select id="departmentSelect" name="departmentId" class="form-select"
                            onchange="updateFields(this.value)">
                        <option value="">-- Tất cả khoa/ngành --</option>
                        <option th:each="dep : ${departments}"
                                th:value="${dep.departmentID}"
                                th:text="${dep.departmentName}"
                                th:selected="${dep.departmentID == selectedDepartmentId}">
                        </option>
                    </select>
                </div>

                <!-- Field -->
                <div class="col-md-2">
                    <label for="fieldSelect" class="form-label fw-semibold">Lĩnh vực</label>
                    <select id="fieldSelect" name="fieldId" class="form-select">
                        <option value="">-- Tất cả lĩnh vực --</option>
                        <option th:each="f : ${fields}"
                                th:value="${f.fieldID}"
                                th:text="${f.fieldName}"
                                th:selected="${f.fieldID == selectedFieldId}">
                        </option>
                    </select>
                </div>

                <!-- Trạng thái -->
                <div class="col-md-2">
                    <label for="statusSelect" class="form-label fw-semibold">Trạng thái</label>
                    <select id="statusSelect" name="status" class="form-select">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option th:each="st : ${T(it.ute.QAUTE.entity.Question.QuestionStatus).values()}"
                                th:value="${st.name()}"
                                th:text="${st}"
                                th:selected="${st.name() == selectedStatus}">
                        </option>
                    </select>
                </div>

                <div class="d-flex align-items-end gap-2">
                    <div class="flex-grow-1">
                        <label for="username" class="form-label fw-semibold">Tìm theo người dùng</label>
                        <input type="text" id="username" name="userName" class="form-control" placeholder="Nhập tên người dùng...">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary fw-semibold px-3">
                            <i class="fas fa-search me-1"></i> Lọc kết quả
                        </button>
                    </div>
                </div>
            </form>

            <!-- Bảng danh sách câu hỏi -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-primary">
                            <tr>
                                <th class="text-center" style="width: 5%;">ID</th>
                                <th style="width: 18%;">Tiêu đề</th>
                                <th style="width: 10%;">Người gửi</th>
                                <th style="width: 13%;">Khoa/Ngành</th>
                                <th style="width: 10%;">Lĩnh vực</th>
                                <th class="text-center" style="width: 11%;">Ngày gửi</th>
                                <th class="text-center" style="width: 7%;">Lượt xem</th>
                                <th class="text-center" style="width: 9%;">Trạng thái</th>
                                <th class="text-center" style="width: 12%;">Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="q : ${questions}"
                                th:classappend="${q.status == 'Pending'} ? 'table-warning' : ''">

                                <!-- ID -->
                                <td class="text-center" th:text="${q.questionID}"></td>

                                <!-- Tiêu đề -->
                                <td th:text="${q.title}" class="fw-semibold"></td>

                                <!-- Người gửi -->
                                <td th:text="${q.user != null && q.user.profile != null ? q.user.profile.fullName : 'Ẩn danh'}"></td>

                                <!-- Khoa/Ngành -->
                                <td th:text="${q.department != null ? q.department.departmentName : '-'}"></td>

                                <!-- Lĩnh vực -->
                                <td th:text="${q.field != null ? q.field.fieldName : '-'}"></td>

                                <!-- Ngày gửi -->
                                <td class="text-center" th:text="${#temporals.format(q.dateSend, 'dd/MM/yyyy HH:mm')}"></td>

                                <!-- Lượt xem -->
                                <td class="text-center" th:text="${q.views}"></td>

                                <!-- Trạng thái -->
                                <td class="text-center">
                                    <span class="badge"
                                          th:classappend="${q.status.name() == 'Pending' ? ' bg-warning text-dark' :
                                                          (q.status.name() == 'Approved' ? ' bg-success' : ' bg-danger')}">
                                        <span th:text="${q.status}"></span>
                                    </span>
                                </td>

                                <!-- Hành động -->
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/manager/questions/edit/{id}(id=${q.questionID})}"
                                           class="btn btn-sm btn-outline-primary"
                                           title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                title="Xóa"
                                                th:data-question-id="${q.questionID}"
                                                th:data-question-title="${q.title}"
                                                onclick="confirmDelete(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Trường hợp không có dữ liệu -->
                            <tr th:if="${#lists.isEmpty(questions)}">
                                <td colspan="9" class="text-center text-muted py-4">Không có câu hỏi nào phù hợp.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Phân trang -->
                <div class="card-footer" th:if="${totalPages > 0}">
                    <nav aria-label="Phân trang câu hỏi">
                        <ul class="pagination justify-content-center mb-0">
                            <!-- Nút Previous -->
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/manager/questions(page=${currentPage - 1}, departmentId=${selectedDepartmentId}, fieldId=${selectedFieldId}, userName=${userName})}"
                                   aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>

                            <!-- Số trang -->
                            <li class="page-item"
                                th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link"
                                   th:href="@{/manager/questions(page=${i}, departmentId=${selectedDepartmentId}, fieldId=${selectedFieldId}, userName=${userName})}"
                                   th:text="${i + 1}">1</a>
                            </li>

                            <!-- Nút Next -->
                            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/manager/questions(page=${currentPage + 1}, departmentId=${selectedDepartmentId}, fieldId=${selectedFieldId}, userName=${userName})}"
                                   aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Thông tin phân trang -->
                    <div class="text-center mt-2 text-muted">
                        <small>
                            Trang <span th:text="${currentPage + 1}">1</span> / <span th:text="${totalPages}">1</span>
                            (Tổng <span th:text="${totalElements}">0</span> câu hỏi)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal xác nhận xóa -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Xác nhận xóa
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Bạn có chắc chắn muốn xóa câu hỏi:</p>
                        <p class="fw-bold text-danger" id="questionTitle"></p>
                        <p class="text-muted mb-0">Hành động này không thể hoàn tác!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <form id="deleteForm" method="post" style="display: inline;">
                            <input type="hidden" name="_method" value="delete">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash me-1"></i>Xóa
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Script cập nhật danh sách Field -->
        <script>
            function updateFields(departmentId) {
                if (!departmentId) {
                    document.getElementById("fieldSelect").innerHTML = '<option value="">-- Tất cả lĩnh vực --</option>';
                    return;
                }
                fetch(`/qaute/manager/fields/by-department/${departmentId}`)
                        .then(res => res.json())
                    .then(fields => {
                        const select = document.getElementById("fieldSelect");
                        select.innerHTML = '<option value="">-- Tất cả lĩnh vực --</option>';
                        fields.forEach(f => {
                            const option = document.createElement("option");
                            option.value = f.fieldID;
                            option.textContent = f.fieldName;
                            select.appendChild(option);
                        });
                    });
            }

            function confirmDelete(button) {
                const questionId = button.getAttribute('data-question-id');
                const questionTitle = button.getAttribute('data-question-title');

                document.getElementById('questionTitle').textContent = questionTitle;

                const form = document.getElementById('deleteForm');
                form.action = '/qaute/manager/questions/delete/' + questionId;
                form.method = 'post'; // Chỉnh method thành POST

                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            }
        </script>

    </th:block>
</th:block>