<!-- fragments/userDropDown.html -->
<!-- Fragment cho notification dropdown v√† user dropdown -->
<ul th:fragment="userDropdown(userName, avatarUrl, isConsultant)"
    class="navbar-nav ms-auto">

    <!-- Notification Bell Icon -->
    <!-- Notification Bell Icon -->
    <li class="nav-item dropdown me-3">
        <a class="nav-link position-relative d-flex align-items-center px-2 py-2"
           href="#" role="button"
           data-bs-toggle="dropdown" aria-expanded="false"
           id="notificationDropdown">

            <!-- ƒê·ªïi icon chu√¥ng th√†nh ·∫£nh -->
            <span class="icon-32">
                <img th:src="@{/images/bell.png}" alt="Bell" width="26" height="26">
            </span>

            <!-- Badge ƒë·∫øm -->
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  id="notificationBadge"
                  th:if="${unreadCount > 0}" th:text="${unreadCount}">
                0
            </span>
        </a>



        <!-- Dropdown menu cho notifications -->
        <div class="dropdown-menu dropdown-menu-end notification-dropdown"
             style="min-width: 350px; max-height: 500px; overflow-y: auto;">
            <div class="dropdown-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Th√¥ng b√°o</h6>
                <span class="badge bg-primary" th:text="${unreadCount}">0</span>
            </div>
            <div class="dropdown-divider"></div>

            <!-- Notification items container -->
            <div id="notificationList">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </li>

    <!-- User Dropdown -->
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle d-flex align-items-center"
           href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img th:src="@{${avatarUrl != null ? avatarUrl : '/images/default_avatar.png'}}"
                 class="rounded-circle me-2" alt="Avatar" width="32" height="32">
            <span class="fw-semibold" th:text="${userName} ?: 'Nguy·ªÖn VƒÉn A'">Nguy·ªÖn VƒÉn A</span>
        </a>

        <ul class="dropdown-menu dropdown-menu-end">
            <!-- N·∫øu l√† consultant -->
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/home}">
                    <i class="fas fa-home me-2"></i>Trang ch√≠nh
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/profile}">
                    <i class="fas fa-user me-2"></i>H·ªì s∆° c√° nh√¢n
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/questions}">
                    <i class="fas fa-comments me-2"></i>C√¢u h·ªèi kh√°ch h√†ng
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/history}">
                    <i class="fas fa-history me-2"></i>L·ªãch s·ª≠ t∆∞ v·∫•n
                </a>
            </li>

            <!-- N·∫øu KH√îNG ph·∫£i consultant -->
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/home/profile}">
                    <i class="fas fa-user me-2"></i>H·ªì s∆° c√° nh√¢n
                </a>
            </li>
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/settings}">
                    <i class="fas fa-cog me-2"></i>C√†i ƒë·∫∑t
                </a>
            </li>
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/advice/history}">
                    <i class="fas fa-history me-2"></i>L·ªãch s·ª≠ t∆∞ v·∫•n
                </a>
            </li>

            <li><hr class="dropdown-divider"></li>

            <!-- Logout cho c·∫£ hai -->
            <li>
                <a class="dropdown-item text-danger" th:href="@{/auth/logout}">
                    <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
                </a>
            </li>
        </ul>
    </li>
</ul>

<!-- Fragment cho header c·ªßa consultant -->
<nav th:fragment="consultantHeader(userName, avatarUrl, isConsultant)"
     class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand text-primary fw-bold fs-3" th:href="@{/consultant/home}">
            <i class="fas fa-graduation-cap me-2"></i>QAUTE
        </a>

        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- Menu tr√°i cho consultant -->
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/home}">Trang ch√≠nh</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/questions}">C√¢u h·ªèi kh√°ch h√†ng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/history}">L·ªãch s·ª≠ t∆∞ v·∫•n</a>
                </li>
                <li>
                    <a class="nav-link fw-semibold" th:href="@{/consultant/profile}">H·ªì s∆° c√° nh√¢n</a>
                </li>
                <li>
                    <a class="nav-link fw-semibold" th:href="@{/consultant/events}">S·ª± ki·ªán c·ªßa t√¥i</a>
                </li>
            </ul>

            <!-- User dropdown -->
            <th:block th:replace="~{fragments/userDropDown :: userDropdown(${userName}, ${avatarUrl}, ${isConsultant})}"></th:block>
        </div>
    </div>
</nav>

<!-- Fragment cho danh s√°ch notification items -->
<div th:fragment="notificationItems">
    <input type="hidden" id="currentAccountId" th:value="${accountId}">
    <div th:if="${notifications.isEmpty()}" class="text-center py-4 text-muted">
        <i class="fas fa-bell-slash fs-3 mb-2"></i>
        <p class="mb-0">Kh√¥ng c√≥ th√¥ng b√°o</p>
    </div>

    <a href="#"
       class="dropdown-item notification-item"
       th:each="notif : ${notifications}"
       th:classappend="${!notif.isRead()} ? 'unread' : ''"
       th:attr="data-receiver-id=${notif.id}, data-priority=${notif.notification.is_priority} ? 'true' : 'false'"
       onclick="return showNotificationDetail(this.dataset.receiverId);">
        <div class="d-flex align-items-start">
            <div class="notification-icon me-3">
                <i class="fas fa-circle-info text-primary"></i>
            </div>
            <div class="flex-grow-1">
                <div class="notification-title-line d-flex align-items-center justify-content-between">
                    <h6 class="notification-title mb-0 text-truncate"
                        th:text="${notif.notification.title}">Ti√™u ƒë·ªÅ th√¥ng b√°o</h6>

                    <small class="notification-time text-muted ms-3 flex-shrink-0">
                        <i class="far fa-clock me-1"></i>
                        <span th:text="${#dates.format(notif.notification.createdDate, 'dd/MM/yyyy HH:mm')}">
        21/10/2025 14:30
      </span>
                    </small>
                </div>

                <p class="notification-text mb-1"
                   th:text="${#strings.abbreviate(notif.notification.content, 60)}">
                    N·ªôi dung th√¥ng b√°o...
                </p>
            </div>
            <div th:if="${!notif.isRead()}" class="ms-2">
                <span class="badge bg-primary rounded-circle" style="width:8px;height:8px;padding:0;"></span>
            </div>
        </div>
    </a>
</div>


<!-- CSS cho notifications -->
<style th:fragment="notificationStyles">
    .notification-dropdown {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .notification-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .notification-item:hover {
        background-color: #f8f9fa;
    }

    .notification-item.unread {
        background-color: #e8f4fd;
    }

    .notification-item.unread:hover {
        background-color: #d4ebfa;
    }

    .notification-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
    }

    .notification-text {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.4;
    }

    .notification-icon {
        font-size: 1.2rem;
        margin-top: 2px;
    }

    #notificationBadge {
        font-size: 0.65rem;
        padding: 0.25em 0.4em;
    }
</style>

<!-- JavaScript cho notifications -->
<script th:fragment="notificationScript" th:inline="javascript">
    // ƒê∆∞·ªùng d·∫´n ‚Äî Thymeleaf s·∫Ω t·ª± g·∫Øn context-path (vd /qaute)
    const USER_NOTI_URL   = /*[[@{/notifications/user}]]*/ '/notifications/user';
    const DETAIL_NOTI_URL = /*[[@{/notifications/detail}]]*/ '/notifications/detail';
    const WS_ENDPOINT     = /*[[@{/ws}]]*/ '/ws';

    // ‚úÖ ƒê·ªîI const th√†nh let ƒë·ªÉ c√≥ th·ªÉ update
    let ACCOUNT_ID = 0;

    let __autoOpenLock = false;               // ch·ªët ch·ªëng m·ªü l·∫∑p
    const AUTO_OPEN_COOLDOWN_MS = 10000;      // 10s

    // ========== CH·∫†Y NGAY KHI SCRIPT LOAD ==========
    (function() {
        console.log("üöÄ Script loaded, initial accountId:", ACCOUNT_ID);

        // N·∫øu DOM ƒë√£ ready th√¨ ch·∫°y lu√¥n, n·∫øu ch∆∞a th√¨ ƒë·ª£i
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();

    function init() {
        console.log("üéØ Initializing notification system...");

        // Setup notification dropdown
        const notificationDropdown = document.getElementById('notificationDropdown');
        if (notificationDropdown) {
            console.log("‚úÖ Found notification dropdown");
            notificationDropdown.addEventListener('click', function() {
                const isOpen = this.parentElement.classList.contains('show');
                if (!isOpen) {
                    console.log("üìÇ Opening dropdown, loading notifications...");
                    loadNotifications();
                }
            });
            loadNotifications();
        } else {
            console.warn("‚ö†Ô∏è Notification dropdown not found");
        }

        // Kh·ªüi t·∫°o STOMP
        initRealtime();

        // ‚ö†Ô∏è KH√îNG g·ªçi startOnlineSocket() ·ªü ƒë√¢y n·ªØa
        // S·∫Ω g·ªçi sau khi c√≥ accountId t·ª´ loadNotifications()
    }

    function maybeAutoOpenPriority() {
        if (__autoOpenLock) {
            console.log("üîí Auto-open locked, skipping");
            return;
        }
        const container = document.getElementById('notificationList');
        if (!container) {
            console.warn("‚ö†Ô∏è Notification list container not found");
            return;
        }

        // t√¨m item ch∆∞a ƒë·ªçc & ∆∞u ti√™n
        const priorityItem = container.querySelector('.notification-item.unread[data-priority="true"]');
        if (priorityItem) {
            const rid = priorityItem.getAttribute('data-receiver-id');
            console.log("üîî Found priority notification, auto-opening:", rid);
            __autoOpenLock = true;
            showNotificationDetail(rid);
            setTimeout(() => {
                __autoOpenLock = false;
                console.log("üîì Auto-open lock released");
            }, AUTO_OPEN_COOLDOWN_MS);
        }
    }

    function loadNotifications() {
        console.log("üì° Loading notifications...");
        fetch(USER_NOTI_URL, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        })
            .then(r => {
                console.log("üì• Notification response received:", r.status);
                return r.text();
            })
            .then(html => {
                document.getElementById('notificationList').innerHTML = html;

                // ‚úÖ L·∫§Y accountId T·ª™ HIDDEN INPUT
                const hiddenInput = document.getElementById('currentAccountId');
                if (hiddenInput) {
                    const newAccountId = parseInt(hiddenInput.value) || 0;
                    console.log("üìå Found accountId in hidden input:", newAccountId);

                    // N·∫øu accountId h·ª£p l·ªá v√† kh√°c v·ªõi gi√° tr·ªã hi·ªán t·∫°i
                    if (newAccountId > 0 && ACCOUNT_ID !== newAccountId) {
                        ACCOUNT_ID = newAccountId;
                        console.log("‚úÖ Updated ACCOUNT_ID to:", ACCOUNT_ID);

                        // Kh·ªüi t·∫°o WebSocket l·∫ßn ƒë·∫ßu
                        if (!window.__online_ws_started) {
                            window.__online_ws_started = true;
                            console.log("üöÄ Starting Online WebSocket for the first time...");
                            startOnlineSocket();
                        }
                    }
                } else {
                    console.warn("‚ö†Ô∏è Hidden input #currentAccountId not found in response");
                }

                const unreadCount = new DOMParser()
                    .parseFromString(html, 'text/html')
                    .querySelectorAll('.notification-item.unread').length;
                console.log("üìä Unread count:", unreadCount);
                updateNotificationBadge(unreadCount);
                maybeAutoOpenPriority();
            })
            .catch((error) => {
                console.error("‚ùå Failed to load notifications:", error);
                document.getElementById('notificationList').innerHTML =
                    '<div class="text-center py-3 text-danger">Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</div>';
            });
    }

    function updateNotificationBadge(count) {
        console.log("üî¢ Updating badge count to:", count);
        const badge = document.getElementById('notificationBadge');
        if (count > 0) {
            if (!badge) {
                const bellIcon = document.querySelector('#notificationDropdown');
                if (bellIcon) {
                    const newBadge = document.createElement('span');
                    newBadge.id = 'notificationBadge';
                    newBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                    newBadge.textContent = count;
                    bellIcon.appendChild(newBadge);
                    console.log("‚úÖ Badge created with count:", count);
                }
            } else {
                badge.textContent = count;
                console.log("‚úÖ Badge updated to:", count);
            }
        } else if (badge) {
            badge.remove();
            console.log("üóëÔ∏è Badge removed (no unread)");
        }
    }

    function showNotificationDetail(receiverId) {
        console.log("üëÅÔ∏è Opening notification detail:", receiverId);
        const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationDropdown'));
        if (dropdown) dropdown.hide();

        fetch(DETAIL_NOTI_URL + '?receiverId=' + encodeURIComponent(receiverId), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        })
            .then(r => {
                console.log("üì• Detail response received:", r.status);
                return r.text();
            })
            .then(html => {
                document.getElementById('notificationModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', html);
                const modalEl = document.getElementById('notificationModal');
                new bootstrap.Modal(modalEl).show();
                console.log("‚úÖ Modal opened");
                loadNotifications(); // BE ƒë√£ mark read ‚Üí refresh danh s√°ch
                modalEl.addEventListener('hidden.bs.modal', () => {
                    modalEl.remove();
                    console.log("üóëÔ∏è Modal removed");
                });
            })
            .catch((error) => {
                console.error("‚ùå Failed to load notification detail:", error);
                alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt th√¥ng b√°o');
            });
        return false;
    }

    // ==== Realtime qua WebSocket/STOMP (theo username) ====
    function initRealtime() {
        console.log("üîå Initializing STOMP WebSocket...");

        // Tr√°nh kh·ªüi t·∫°o nhi·ªÅu l·∫ßn n·∫øu fragment ƒë∆∞·ª£c include nhi·ªÅu ch·ªó
        if (window.__qaute_ws_inited) {
            console.log("‚ö†Ô∏è STOMP already initialized");
            return;
        }
        window.__qaute_ws_inited = true;

        function connect() {
            if (!window.SockJS || !window.Stomp) {
                console.error('‚ùå SockJS/STOMP ch∆∞a n·∫°p. Ki·ªÉm tra <script> trong head.html');
                return;
            }

            console.log("üîó Connecting to STOMP at:", WS_ENDPOINT);
            const sock = new SockJS(WS_ENDPOINT);
            const client = Stomp.over(sock);
            client.debug = null; // t·∫Øt log

            client.connect({}, function onConnect() {
                console.log("‚úÖ STOMP connected successfully");
                window.__qaute_stomp = client;

                // Server d√πng convertAndSendToUser(username, "/queue/notifications", payload)
                client.subscribe('/user/queue/notifications', function(message) {
                    console.log("üîî New notification received via STOMP:", message);
                    // C√≥ th√¥ng b√°o m·ªõi ‚Üí refresh list + badge
                    loadNotifications();
                    maybeAutoOpenPriority();
                });
                console.log("‚úÖ Subscribed to /user/queue/notifications");
            }, function onError(error) {
                console.error("‚ùå STOMP connection error:", error);
                console.log("üîÑ Reconnecting in 3 seconds...");
                setTimeout(connect, 3000); // auto-reconnect ƒë∆°n gi·∫£n
            });
        }
        connect();
    }

    // ==== WebSocket cho Online Status ====
    function startOnlineSocket() {
        console.log("üîå Starting Online Status WebSocket...");
        console.log("üÜî Account ID:", ACCOUNT_ID);

        if (!ACCOUNT_ID || ACCOUNT_ID === 0) {
            console.warn("‚ö†Ô∏è Kh√¥ng c√≥ accountId h·ª£p l·ªá, b·ªè qua ping online");
            return;
        }

        // L·∫•y context path t·ª´ Thymeleaf (n·∫øu c√≥)
        const contextPath = /*[[@{/}]]*/ '/';

        // X√°c ƒë·ªãnh URL WebSocket (auto ch·ªçn ws:// ho·∫∑c wss://)
        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsUrl = `${wsProtocol}${window.location.host}${contextPath}realtime/online?id=${ACCOUNT_ID}`;

        console.log("üìç WebSocket URL:", wsUrl);
        console.log("üîó Connecting to Online Status WebSocket...");

        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("‚úÖ Online WS connected successfully");
            // G·ª≠i ping ngay khi k·∫øt n·ªëi
            ws.send("PING");
            console.log("üíì Initial PING sent");
        };

        ws.onclose = (event) => {
            console.log("‚ùå Online WS closed");
            console.log("   Code:", event.code);
            console.log("   Reason:", event.reason || "No reason provided");
            console.log("   Clean:", event.wasClean);
        };

        ws.onerror = (error) => {
            console.error("‚ö†Ô∏è WS Error:", error);
            console.error("   ReadyState:", ws.readyState);
        };

        ws.onmessage = (message) => {
            console.log("üì® Received message from server:", message.data);
        };

        // G·ª≠i ping m·ªói 30 gi√¢y
        const pingInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send("PING");
                console.debug("üíì PING sent for user", ACCOUNT_ID);
            } else {
                console.warn("‚ö†Ô∏è Cannot send PING, WebSocket state:", ws.readyState);
                console.warn("   States: 0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED");
            }
        }, 30000);

        // Cleanup khi ƒë√≥ng trang
        window.addEventListener('beforeunload', () => {
            console.log("üëã Page unloading, cleaning up WebSocket...");
            clearInterval(pingInterval);
            ws.close();
        });
    }
</script>

