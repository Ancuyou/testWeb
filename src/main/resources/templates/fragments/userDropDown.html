<!-- fragments/userDropDown.html -->
<!-- Fragment cho notification dropdown và user dropdown -->
<ul th:fragment="userDropdown(userName, avatarUrl, isConsultant)"
    class="navbar-nav ms-auto">

    <!-- Notification Bell Icon -->
    <!-- Notification Bell Icon -->
    <li class="nav-item dropdown me-3">
        <a class="nav-link position-relative d-flex align-items-center px-2 py-2"
           href="#" role="button"
           data-bs-toggle="dropdown" aria-expanded="false"
           id="notificationDropdown">

            <!-- Đổi icon chuông thành ảnh -->
            <span class="icon-32">
                <img th:src="@{/images/bell.png}" alt="Bell" width="26" height="26">
            </span>

            <!-- Badge đếm -->
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  id="notificationBadge"
                  th:if="${unreadCount > 0}" th:text="${unreadCount}">
                0
            </span>
        </a>



        <!-- Dropdown menu cho notifications -->
        <div class="dropdown-menu dropdown-menu-end notification-dropdown"
             style="min-width: 350px; max-height: 500px; overflow-y: auto;">
            <div class="dropdown-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Thông báo</h6>
                <span class="badge bg-primary" th:text="${unreadCount}">0</span>
            </div>
            <div class="dropdown-divider"></div>

            <!-- Notification items container -->
            <div id="notificationList">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </li>

    <!-- User Dropdown -->
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle d-flex align-items-center"
           href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img th:src="@{${avatarUrl != null ? avatarUrl : '/images/default_avatar.png'}}"
                 class="rounded-circle me-2" alt="Avatar" width="32" height="32">
            <span class="fw-semibold" th:text="${userName} ?: 'Nguyễn Văn A'">Nguyễn Văn A</span>
        </a>

        <ul class="dropdown-menu dropdown-menu-end">
            <!-- Nếu là consultant -->
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/home}">
                    <i class="fas fa-home me-2"></i>Trang chính
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/profile}">
                    <i class="fas fa-user me-2"></i>Hồ sơ cá nhân
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/questions}">
                    <i class="fas fa-comments me-2"></i>Câu hỏi khách hàng
                </a>
            </li>
            <li th:if="${isConsultant}">
                <a class="dropdown-item" th:href="@{/consultant/history}">
                    <i class="fas fa-history me-2"></i>Lịch sử tư vấn
                </a>
            </li>

            <!-- Nếu KHÔNG phải consultant -->
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/home/profile}">
                    <i class="fas fa-user me-2"></i>Hồ sơ cá nhân
                </a>
            </li>
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/settings}">
                    <i class="fas fa-cog me-2"></i>Cài đặt
                </a>
            </li>
            <li th:unless="${isConsultant}">
                <a class="dropdown-item" th:href="@{/advice/history}">
                    <i class="fas fa-history me-2"></i>Lịch sử tư vấn
                </a>
            </li>

            <li><hr class="dropdown-divider"></li>

            <!-- Logout cho cả hai -->
            <li>
                <a class="dropdown-item text-danger" th:href="@{/auth/logout}">
                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                </a>
            </li>
        </ul>
    </li>
</ul>

<!-- Fragment cho header của consultant -->
<nav th:fragment="consultantHeader(userName, avatarUrl, isConsultant)"
     class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand text-primary fw-bold fs-3" th:href="@{/consultant/home}">
            <i class="fas fa-graduation-cap me-2"></i>QAUTE
        </a>

        <button class="navbar-toggler" type="button"
                data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- Menu trái cho consultant -->
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/home}">Trang chính</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/questions}">Câu hỏi khách hàng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-semibold" th:href="@{/consultant/history}">Lịch sử tư vấn</a>
                </li>
            </ul>

            <!-- User dropdown -->
            <th:block th:replace="~{fragments/userDropDown :: userDropdown(${userName}, ${avatarUrl}, ${isConsultant})}"></th:block>
        </div>
    </div>
</nav>

<!-- Fragment cho danh sách notification items -->
<div th:fragment="notificationItems">
    <div th:if="${notifications.isEmpty()}" class="text-center py-4 text-muted">
        <i class="fas fa-bell-slash fs-3 mb-2"></i>
        <p class="mb-0">Không có thông báo</p>
    </div>

    <a href="#"
       class="dropdown-item notification-item"
       th:each="notif : ${notifications}"
       th:classappend="${!notif.isRead()} ? 'unread' : ''"
       th:attr="data-receiver-id=${notif.id}, data-priority=${notif.notification.is_priority} ? 'true' : 'false'"
       onclick="return showNotificationDetail(this.dataset.receiverId);">
        <div class="d-flex align-items-start">
            <div class="notification-icon me-3">
                <i class="fas fa-circle-info text-primary"></i>
            </div>
            <div class="flex-grow-1">
                <div class="notification-title-line d-flex align-items-center justify-content-between">
                    <h6 class="notification-title mb-0 text-truncate"
                        th:text="${notif.notification.title}">Tiêu đề thông báo</h6>

                    <small class="notification-time text-muted ms-3 flex-shrink-0">
                        <i class="far fa-clock me-1"></i>
                        <span th:text="${#dates.format(notif.notification.createdDate, 'dd/MM/yyyy HH:mm')}">
        21/10/2025 14:30
      </span>
                    </small>
                </div>

                <p class="notification-text mb-1"
                   th:text="${#strings.abbreviate(notif.notification.content, 60)}">
                    Nội dung thông báo...
                </p>
            </div>
            <div th:if="${!notif.isRead()}" class="ms-2">
                <span class="badge bg-primary rounded-circle" style="width:8px;height:8px;padding:0;"></span>
            </div>
        </div>
    </a>
</div>


<!-- CSS cho notifications -->
<style th:fragment="notificationStyles">
    .notification-dropdown {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .notification-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .notification-item:hover {
        background-color: #f8f9fa;
    }

    .notification-item.unread {
        background-color: #e8f4fd;
    }

    .notification-item.unread:hover {
        background-color: #d4ebfa;
    }

    .notification-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
    }

    .notification-text {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.4;
    }

    .notification-icon {
        font-size: 1.2rem;
        margin-top: 2px;
    }

    #notificationBadge {
        font-size: 0.65rem;
        padding: 0.25em 0.4em;
    }
</style>

<!-- JavaScript cho notifications -->
<script th:fragment="notificationScript" th:inline="javascript">
    // Đường dẫn — Thymeleaf sẽ tự gắn context-path (vd /qaute)
    const USER_NOTI_URL   = /*[[@{/notifications/user}]]*/ '/notifications/user';
    const DETAIL_NOTI_URL = /*[[@{/notifications/detail}]]*/ '/notifications/detail';
    const WS_ENDPOINT     = /*[[@{/ws}]]*/ '/ws';
    let __autoOpenLock = false;               // chốt chống mở lặp
    const AUTO_OPEN_COOLDOWN_MS = 10000;      // 10s
    document.addEventListener('DOMContentLoaded', function() {
        const notificationDropdown = document.getElementById('notificationDropdown');
        if (notificationDropdown) {
            notificationDropdown.addEventListener('click', function() {
                const isOpen = this.parentElement.classList.contains('show');
                if (!isOpen) loadNotifications();
            });
            loadNotifications();
        }
        initRealtime(); // <<< thêm dòng này để bật realtime
    });
    function maybeAutoOpenPriority() {
        if (__autoOpenLock) return;
        const container = document.getElementById('notificationList');
        if (!container) return;

        // tìm item chưa đọc & ưu tiên
        const priorityItem = container.querySelector('.notification-item.unread[data-priority="true"]');
        if (priorityItem) {
            const rid = priorityItem.getAttribute('data-receiver-id');
            __autoOpenLock = true;
            showNotificationDetail(rid);          // mở modal chi tiết
            setTimeout(() => { __autoOpenLock = false; }, AUTO_OPEN_COOLDOWN_MS);
        }
    }
    function loadNotifications() {
        fetch(USER_NOTI_URL, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        })
            .then(r => r.text())
            .then(html => {
                document.getElementById('notificationList').innerHTML = html;
                const unreadCount = new DOMParser()
                    .parseFromString(html, 'text/html')
                    .querySelectorAll('.notification-item.unread').length;
                updateNotificationBadge(unreadCount);
                maybeAutoOpenPriority();
            })
            .catch(() => {
                document.getElementById('notificationList').innerHTML =
                    '<div class="text-center py-3 text-danger">Không thể tải thông báo</div>';
            });
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (count > 0) {
            if (!badge) {
                const bellIcon = document.querySelector('#notificationDropdown');
                const newBadge = document.createElement('span');
                newBadge.id = 'notificationBadge';
                newBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                newBadge.textContent = count;
                bellIcon.appendChild(newBadge);
            } else {
                badge.textContent = count;
            }
        } else if (badge) {
            badge.remove();
        }
    }

    function showNotificationDetail(receiverId) {
        const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notificationDropdown'));
        if (dropdown) dropdown.hide();

        fetch(DETAIL_NOTI_URL + '?receiverId=' + encodeURIComponent(receiverId), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        })
            .then(r => r.text())
            .then(html => {
                document.getElementById('notificationModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', html);
                const modalEl = document.getElementById('notificationModal');
                new bootstrap.Modal(modalEl).show();
                loadNotifications(); // BE đã mark read → refresh danh sách
                modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
            })
            .catch(() => alert('Không thể tải chi tiết thông báo'));
        return false;
    }

    // ==== Realtime qua WebSocket/STOMP (theo username) ====
    function initRealtime() {
        // Tránh khởi tạo nhiều lần nếu fragment được include nhiều chỗ
        if (window.__qaute_ws_inited) return;
        window.__qaute_ws_inited = true;

        function connect() {
            if (!window.SockJS || !window.Stomp) {
                console.warn('SockJS/STOMP chưa nạp. Kiểm tra <script> trong head.html');
                return;
            }
            const sock = new SockJS(WS_ENDPOINT);
            const client = Stomp.over(sock);
            client.debug = null; // tắt log

            client.connect({}, function onConnect() {
                window.__qaute_stomp = client;
                // Server dùng convertAndSendToUser(username, "/queue/notifications", payload)
                client.subscribe('/user/queue/notifications', function() {
                    // Có thông báo mới → refresh list + badge
                    loadNotifications();
                    maybeAutoOpenPriority();
                });
            }, function onError() {
                setTimeout(connect, 3000); // auto-reconnect đơn giản
            });
        }
        connect();
    }
</script>

