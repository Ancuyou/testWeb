<!-- templates/fragments/consultant/consultant-chat.html -->
<section th:fragment="consultant-chat" id="chat-messaging" class="py-4" style="background-color: #CDC4F9;">
  <div class="container py-4">
    <div class="row">
      <div class="col-md-12">
        <div class="card" id="chat3" style="border-radius: 15px;">
          <div class="card-body">
            <!-- Chat Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold">Trò chuyện</h2>
                    <p class="text-muted">Kết nối và hỗ trợ sinh viên qua hệ thống tin nhắn trực tiếp</p>
                </div>
            </div>

            <div class="row">
              <!-- Conversation List -->
              <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
                <div class="p-3">
                  <!-- Search Box -->
                  <div class="input-group rounded mb-3">
                    <input type="search" class="form-control rounded" placeholder="Tìm kiếm..." aria-label="Search"
                      aria-describedby="search-addon" />
                    <span class="input-group-text border-0" id="search-addon">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>

                  <!-- Contact List -->
                  <div style="position: relative; height: 400px; overflow-y: auto;">
                    <ul class="list-unstyled mb-0">
                      <!-- Kiểm tra nếu có tin nhắn -->
                      <th:block th:if="${recentMessages != null && !recentMessages.isEmpty()}">
                        <!-- Duyệt qua danh sách tin nhắn gần đây -->
                        <li th:each="message : ${recentMessages}" class="p-2 border-bottom">
                          <!-- Xác định người gửi/nhận là ai (không phải consultant) -->
                          <a href="#" th:data-user-id="${message.senderID == account?.profile?.profileID ? message.receiverID : message.senderID}" 
                             class="chat-contact d-flex justify-content-between">
                            <div class="d-flex flex-row">
                              <div class="position-relative">
                                <!-- Hiển thị ảnh của người chat với consultant -->
                                <img th:src="${message.senderID == account?.profile?.profileID ? 
                                      (message.receiver?.avatar != null ? message.receiver?.avatar : 'https://via.placeholder.com/60') : 
                                      (message.sender?.avatar != null ? message.sender?.avatar : 'https://via.placeholder.com/60')}"
                                  alt="avatar" class="d-flex align-self-center me-3" width="60">
                                <!-- Trạng thái online/offline -->
                                <span class="badge bg-success badge-dot position-absolute bottom-0 end-0"></span>
                              </div>
                              <div class="pt-1">
                                <!-- Tên người chat với consultant -->
                                <p class="fw-bold mb-0" th:text="${message.senderID == account?.profile?.profileID ? 
                                      message.receiver?.fullName : message.sender?.fullName}">Tên người dùng</p>
                                <!-- Nội dung tin nhắn gần nhất -->
                                <p class="small text-muted" th:text="${#strings.abbreviate(message.content, 40)}">Nội dung tin nhắn...</p>
                              </div>
                            </div>
                            <div class="pt-1">
                              <!-- Thời gian tin nhắn -->
                              <p class="small text-muted mb-1" th:text="${#temporals.format(message.createdAt, 'HH:mm')}">12:45</p>
                              <!-- Số lượng tin nhắn chưa đọc - có thể thêm trong tương lai -->
                              <th:block th:if="${message.status != 'read' && message.senderID != account?.profile?.profileID}">
                                <span class="badge bg-danger rounded-pill float-end">1</span>
                              </th:block>
                            </div>
                          </a>
                        </li>
                      </th:block>
                      
                      <!-- Hiển thị khi không có tin nhắn nào -->
                      <th:block th:if="${recentMessages == null || recentMessages.isEmpty()}">
                        <li class="p-3 text-center">
                          <div class="d-flex flex-column align-items-center">
                            <i class="far fa-comment-dots mb-3" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mb-0">Chưa nhắn tin với ai</p>
                            <p class="text-muted small">Khi có user nhắn tin, họ sẽ xuất hiện ở đây</p>
                          </div>
                        </li>
                      </th:block>
                            <div>
                              <span class="badge bg-danger badge-dot position-absolute bottom-0 end-0"></span>
                            </div>
                            <div class="pt-1">
                              <p class="fw-bold mb-0">Phạm Thị D</p>
                              <p class="small text-muted">Thầy/cô có thể giúp em về vấn đề học phí không?</p>
                            </div>
                          </div>
                          <div class="pt-1">
                            <p class="small text-muted mb-1">Hôm qua</p>
                          </div>
                        </a>
                      </li>
                      
                      <!-- Contact 5 - Away -->
                      <li class="p-2 border-bottom">
                        <a href="#!" class="d-flex justify-content-between">
                          <div class="d-flex flex-row">
                            <div class="position-relative">
                              <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava5-bg.webp"
                                alt="avatar" class="d-flex align-self-center me-3" width="60">
                              <span class="badge bg-warning badge-dot position-absolute bottom-0 end-0"></span>
                            </div>
                            <div class="pt-1">
                              <p class="fw-bold mb-0">Hoàng Văn E</p>
                              <p class="small text-muted">Em đã tìm hiểu thông tin và sẽ thử đăng ký...</p>
                            </div>
                          </div>
                          <div class="pt-1">
                            <p class="small text-muted mb-1">03/10</p>
                          </div>
                        </a>
                      </li>
                      
                      <!-- Contact 6 - Online -->
                      <li class="p-2">
                        <a href="#!" class="d-flex justify-content-between">
                          <div class="d-flex flex-row">
                            <div class="position-relative">
                              <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp"
                                alt="avatar" class="d-flex align-self-center me-3" width="60">
                              <span class="badge bg-success badge-dot position-absolute bottom-0 end-0"></span>
                            </div>
                            <div class="pt-1">
                              <p class="fw-bold mb-0">Trương Minh F</p>
                              <p class="small text-muted">Em muốn hỏi về quy trình thực tập...</p>
                            </div>
                          </div>
                          <div class="pt-1">
                            <p class="small text-muted mb-1">01/10</p>
                          </div>
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Chat Window -->
              <div class="col-md-6 col-lg-7 col-xl-8">
                <!-- Chat Messages -->
                <div class="pt-3 pe-3" style="position: relative; height: 400px; overflow-y: auto;">
                  <!-- Time Divider -->
                  <div class="text-center mb-4">
                    <span class="badge bg-light text-dark px-3 py-2">Hôm nay, 12:30</span>
                  </div>

                  <!-- Received Message -->
                  <div class="d-flex flex-row justify-content-start mb-4">
                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                    <div>
                      <p class="small p-2 ms-3 mb-1 rounded-3 bg-body-tertiary">
                        Chào thầy/cô, em có một số thắc mắc về thủ tục đăng ký học phần cho học kỳ mới. Em không biết có cần phải hoàn thành các môn tiên quyết trước không?
                      </p>
                      <p class="small ms-3 mb-3 rounded-3 text-muted float-end">12:30</p>
                    </div>
                  </div>

                  <!-- Sent Message -->
                  <div class="d-flex flex-row justify-content-end mb-4">
                    <div>
                      <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">
                        Chào em, đối với đăng ký học phần, em cần kiểm tra điều kiện tiên quyết cho từng môn học cụ thể. Thông tin này được hiển thị trong phần mô tả học phần trên cổng thông tin.
                      </p>
                      <p class="small me-3 mb-3 rounded-3 text-muted">12:35</p>
                    </div>
                    <img src="https://via.placeholder.com/45" class="rounded-circle"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                  </div>

                  <!-- Sent Message -->
                  <div class="d-flex flex-row justify-content-end mb-4">
                    <div>
                      <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">
                        Để xem chi tiết, em có thể vào mục "Đăng ký học phần" trên cổng sinh viên, sau đó chọn "Xem điều kiện tiên quyết" cho các môn học.
                      </p>
                      <p class="small me-3 mb-3 rounded-3 text-muted">12:36</p>
                    </div>
                    <img src="https://via.placeholder.com/45" class="rounded-circle"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                  </div>

                  <!-- Received Message -->
                  <div class="d-flex flex-row justify-content-start mb-4">
                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                    <div>
                      <p class="small p-2 ms-3 mb-1 rounded-3 bg-body-tertiary">
                        Em đã hiểu. Vậy thời gian đăng ký cho học kỳ tới bắt đầu từ khi nào ạ?
                      </p>
                      <p class="small ms-3 mb-3 rounded-3 text-muted float-end">12:40</p>
                    </div>
                  </div>

                  <!-- Sent Message -->
                  <div class="d-flex flex-row justify-content-end mb-4">
                    <div>
                      <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">
                        Thời gian đăng ký học phần cho học kỳ tới sẽ bắt đầu từ ngày 15/10/2025 và kết thúc vào ngày 25/10/2025. Nhà trường sẽ gửi email thông báo chi tiết cho tất cả sinh viên trong tuần này.
                      </p>
                      <p class="small me-3 mb-3 rounded-3 text-muted">12:43</p>
                    </div>
                    <img src="https://via.placeholder.com/45" class="rounded-circle"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                  </div>

                  <!-- Received Message -->
                  <div class="d-flex flex-row justify-content-start mb-4">
                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                      alt="avatar 1" style="width: 45px; height: 100%;">
                    <div>
                      <p class="small p-2 ms-3 mb-1 rounded-3 bg-body-tertiary">
                        Cảm ơn thầy/cô đã giải đáp chi tiết. Em sẽ chuẩn bị sẵn sàng cho đợt đăng ký tới.
                      </p>
                      <p class="small ms-3 mb-3 rounded-3 text-muted float-end">12:45</p>
                    </div>
                  </div>
                </div>

                <!-- Message Input -->
                <div class="text-muted d-flex justify-content-start align-items-center pe-3 pt-3 mt-2">
                  <img src="https://via.placeholder.com/40" class="rounded-circle" 
                    alt="avatar 3" style="width: 40px; height: 40px;">
                  <input type="text" class="form-control form-control-lg ms-3" id="messageInput"
                    placeholder="Nhập tin nhắn...">
                  <a class="ms-1 text-muted" href="#!"><i class="fas fa-paperclip"></i></a>
                  <a class="ms-3 text-muted" href="#!"><i class="fas fa-smile"></i></a>
                  <a class="ms-3 btn btn-primary" href="#!"><i class="fas fa-paper-plane"></i></a>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CSS for Badge Dots -->
<style>
.badge-dot {
    width: 12px;
    height: 12px;
    border: 2px solid white;
}
</style>